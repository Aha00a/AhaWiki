@import logics.wikis.interpreters.InterpreterMap
@import com.aha00a.commons.Implicits._
@(
        mapsJavaScriptAPIKey:String,
        url:String,
        sheetName:String,
        seqLocationLastVisited:Seq[InterpreterMap.LocationListVisited],
        seqHeaderName: Seq[String],
        seqHeaderRest: Seq[String]
)(implicit wikiContext: WikiContext, request: play.api.mvc.Request[Any])
@for(id <- Seq(com.aha00a.commons.utils.UuidUtil.newStringWithoutDash)) {
    <div class="interpreterMap">
        <div class="mapArea">
            <div class="aspectRatioWrapper">
                <div class="ratio_16_9"></div>
                <div class="aspectRatioContent">
                    <div id="@(id)" class="map" style="width: 100%; height: 100%"></div>
                </div>
            </div>
            @if(url && sheetName) {
                <div class="sheetLink">
                    <a href="@url" target="_blank">Data Source</a>
                </div>
                @if(!wikiContext.isPreview) {
                    <div class="refreshLink" id="sync@id" data-url="@url" data-sheet="@sheetName">
                        <i class="fas fa-sync"></i>
                    </div>
                    <script type="text/javascript">
                        $(function () {
                            $('#sync@id').click(function () {
                                if(!confirm('Do you want re-fetch data from data source?'))
                                    return false;

                                $("body").append($('<div class="ahaWikiLoader bg"></div><div class="ahaWikiLoader circle"/>'))
                                $.ajax({
                                    url: '@routes.Wiki.syncGoogleSpreadsheet()',
                                    method: 'post',
                                    headers: {
                                        'Csrf-Token': '@play.filters.csrf.CSRF.getToken.map(_.value)'
                                    },
                                    data: {
                                        pageName: '@wikiContext.name',
                                        url: '@url',
                                        sheetName: '@sheetName',
                                    },
                                    success: function (data, textStatus, jqXHR) {
                                        $('.ahaWikiLoader').remove();
                                        if(data === 'NotChanged') {
                                            alert('Content is not changed.');
                                            return;
                                        }
                                        location.reload();
                                    },
                                    error: function (jqXHR, textStatus, errorThrown) {
                                        debugger;
                                        $('.ahaWikiLoader').remove();
                                    }
                                });
                                return false;
                            });
                        });
                    </script>
                }
            }
        </div>
        <div class="tableArea">
            <table class="simpleTable tablesorter">
                <thead>
                    <tr>
                        @for(headerName <- seqHeaderName) {
                            <th rowspan="2">@headerName</th>
                        }
                        @if(seqLocationLastVisited.exists(_.listVisited.nonEmpty)) {
                            <th colspan="3">Visited</th>
                        }
                        @for(headerName <- seqHeaderRest) {
                            <th rowspan="2">@headerName</th>
                        }
                    </tr>
                    @if(seqLocationLastVisited.exists(_.listVisited.nonEmpty)) {
                        <tr>
                            <th>Last</th>
                            <th>First</th>
                            <th>Count</th>
                        </tr>
                    }
                </thead>
                <tbody>
                    @for((locationLastVisited, i) <- seqLocationLastVisited.filter(!_.location.latLng.lat.isNaN).zipWithIndex) {
                        <tr>
                            <td>
                                @if(locationLastVisited.location.exists) {
                                    <a href="@(locationLastVisited.location.name)">@(locationLastVisited.location.name)</a>
                                } else {
                                    @(locationLastVisited.location.name)
                                }
                            </td>
                            <td>
                                @if(locationLastVisited.location.urlMap){
                                    <a href="@(locationLastVisited.location.urlMap)" target="_blank">@(locationLastVisited.location.address)</a>
                                } else {
                                    @(locationLastVisited.location.address)
                                }
                            </td>
                            <td>@(locationLastVisited.location.score)</td>
                            @if(seqLocationLastVisited.exists(_.listVisited.nonEmpty)) {
                                <td>@(locationLastVisited.listVisited.headOption.getOrElse(""))</td>
                                <td>@(locationLastVisited.listVisited.lastOption.getOrElse(""))</td>
                                <td>@(locationLastVisited.listVisited.length)</td>
                            }
                            @for(s <- locationLastVisited.location.rest) {
                                @if(s._2.startsWith("http")) {
                                    <td>
                                        <a href="@(s._2)" target="_blank">Link</a>
                                    </td>
                                } else {
                                    <td>@(s._2)</td>
                                }
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
    <script type="text/javascript">
        arrayOnGoogleMapLoaded.push(function () {
            var map = new google.maps.Map(document.getElementById('@id'), {
                options: {
                    gestureHandling: 'greedy'
                }
            });

            var markers = [];
            @for((locationLastVisited, i) <- seqLocationLastVisited.filter(!_.location.latLng.lat.isNaN).zipWithIndex) {
                (function() {
                    var latLng = {
                        lat: @locationLastVisited.location.latLng.latWithNoise,
                        lng: @locationLastVisited.location.latLng.lngWithNoise
                    };
                    var marker = new google.maps.Marker({
                        position: latLng,
                        map:map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: @(locationLastVisited.location.scale),
                            strokeColor: '@(locationLastVisited.location.strokeColor)',
                            strokeWeight: 1,
                            fillColor: '@(locationLastVisited.location.fillColor)',
                            fillOpacity: @(locationLastVisited.location.fillOpacity),
                            labelOrigin: {
                                x: 0,
                                y: 2
                            }
                        },
                        title: '@locationLastVisited.location.name - @locationLastVisited.location.address',
                        label: {
                            fontWeight: 'bold',
                            color: '@(locationLastVisited.location.strokeColor)',
                            text: '@locationLastVisited.location.name',
                        }
                    });
                    marker.addListener('click', function() {
                        var infowindow = new google.maps.InfoWindow({
                            content: $('#@(id)_@i').html()
                        });

                        infowindow.open(marker.get('map'), marker);
                    });
                    markers.push(marker);
                })();
            }

            var bounds = new google.maps.LatLngBounds();
            for (var i = 0; i < markers.length; i++) {
                bounds.extend(markers[i].position);
            }

            map.fitBounds(bounds);
        });
    </script>
    @for((locationLastVisited, i) <- seqLocationLastVisited.filter(!_.location.latLng.lat.isNaN).zipWithIndex) {
        <script type="text/html" id="@(id)_@i">
            <div class="googleMapsInfoWindow">
                <div class="title">@(locationLastVisited.location.name)</div>
                <div class="score">@(locationLastVisited.location.score)</div>
                <div class="address">@(locationLastVisited.location.address)</div>
                <div class="rest">
                    @for((k, v) <- locationLastVisited.location.rest) {
                        <div class="restItem">@k :
                            @if(v.startsWith("http")) {
                                <a href="@v" target="_blank">@v</a>
                            } else {
                                @v
                            }
                        </div>
                    }
                </div>
            </div>
        </script>
    }
}
