@(page: models.Database.Page)(implicit wikiContext: models.WikiContext, request: play.api.mvc.Request[Any])
@import helper._
@_base(page.name, "") {
    <script type="text/javascript" src="/public/js/jquery.paste_image_reader.js"></script>
    <script type="text/javascript">
        $(function(){
            $.fn.insertAtCaret = function(myValue) {
                return this.each(function() {
                    var me = this;
                    if (document.selection) { // IE
                        me.focus();
                        sel = document.selection.createRange();
                        sel.text = myValue;
                        me.focus();
                    } else if (me.selectionStart || me.selectionStart == '0') { // Real browsers
                        var startPos = me.selectionStart, endPos = me.selectionEnd, scrollTop = me.scrollTop;
                        me.value = me.value.substring(0, startPos) + myValue + me.value.substring(endPos, me.value.length);
                        me.focus();
                        me.selectionStart = startPos + myValue.length;
                        me.selectionEnd = startPos + myValue.length;
                        me.scrollTop = scrollTop;
                    } else {
                        me.value += myValue;
                        me.focus();
                    }
                });
            };

            $("html").pasteImageReader(function(results) {
                $('<div/>').css({
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)'
                }).append(
                    $('<div/>').css({
                        backgroundSize: 'contain',
                        backgroundImage: 'url(' + results.dataURL + ')',
                        backgroundPosition: 'center',
                        backgroundRepeat: 'no-repeat',
                        position: 'fixed',
                        top: '100px',
                        left: '100px',
                        right: '100px',
                        bottom: '100px'
                    })
                ).click(function () {
                    $(this).remove();
                    $('textarea').focus()
                }).appendTo('body');
                $('textarea').insertAtCaret('[[Image(' + results.dataURL + ')]]\n')
            });
        });
    </script>
    <script type="text/javascript">
        function preview() {
            $.post('/preview', {
                csrfToken: $('[name=csrfToken]').val(),
                name: '@(page.name)',
                text: $('textarea[name=text]').val()
            }, function (data, textStatus, jqXHR) {
                $('.previewPane').html(data);
                $("[name=text]").css({ height: $('.previewPane').height()});
            });
        }

        var timer;
        $(function(){
            var $form = $(".form");
            $form.validate({
                rules: { comment: "required" },
                errorPlacement: function () { }
            });
            $form.ajaxForm({
                success: function(result) {
                    location.href = location.pathname;
                },
                error: function (jqXHR) {
                    alert(jqXHR.statusText);
                }
            });

            $('textarea[name=text]').bind('input cut paste keydown keyup keypress blur', function () {
                if(timer) {
                    clearTimeout(timer);
                    timer = null;
                }

                timer = setTimeout(preview, 2000)
            });
            preview();
        });
    </script>
} {
    <div class="wikiContent">
        <div class="limitWidth">
            <h1>Edit - <a href="?">@page.name</a></h1>
        </div>
        <div class="limitWidth">
            <div class="edit">
                <table class="layout">
                    <tr>
                        <td>
                        @form(routes.Wiki.save(page.name), 'class -> "form") {
                            @CSRF.formField
                            <input type="hidden" name="revision" value="@page.revision"/>
                            <textarea name="text" style="min-height: 500px;">@page.content</textarea>
                            <label>Comment <input type="text" name="comment" placeholder="Comment"/></label>
                            <input type="submit" value="Save"/>
                        }
                        </td>
                        <td>
                            <div class="previewPane"></div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
}
